// ============================================================================
// L3_ReactDevServer_PostExploitation_Chain — HUNT MODE (Wide Net)
// Author: Ala Dabat
// Version: 2025-12 (L3 Hunt)
// Platforms: Windows + Linux (MDE Advanced Hunting / Sentinel)
// Purpose:
//   Hunt for post-exploitation side-effects originating from web/runtime parents
//   (e.g., Node/Java/.NET/IIS) by correlating:
//     (1) Runtime/Web parent → suspicious child execution
//     (2) Runtime/Web parent → suspicious network connections
//     (3) Runtime/Web parent → suspicious file writes / sensitive file touches
//
// Design Note (Truth in Telemetry):
//   The in-memory exploitation step (e.g., HMR / eval / vm.runInThisContext)
//   is typically not directly visible in EDR. This hunt detects the *side-effects*.
//
// MITRE:
//   TA0002 Execution          (T1059, T1203, T1059.003)
//   TA0003 Persistence        (T1543, T1053)
//   TA0005 Defense Evasion    (T1027, T1218)
//   TA0011 Command and Control(T1071, T1105)
// ============================================================================

let lookback = 7d;
let ChainWindow = 10m;

// ----------------------------
// HUNT MODE: NO ALLOWLISTING
// ----------------------------
let EnableAllowlist = false;

// Runtime/Web parents (extend per environment)
let ParentProc = dynamic([
  "node.exe","node",
  "w3wp.exe","iisexpress.exe",
  "httpd.exe","nginx.exe",
  "java.exe","java",
  "dotnet.exe","dotnet",
  "gunicorn","uwsgi"
]);

// Suspicious child processes (shells + LOLBins + network tools)
let ChildProc = dynamic([
  "powershell.exe","pwsh.exe","cmd.exe",
  "mshta.exe","wscript.exe","cscript.exe",
  "rundll32.exe","regsvr32.exe","certutil.exe",
  "msbuild.exe","csc.exe","installutil.exe","msiexec.exe",
  "sh","bash","dash","zsh",
  "python","python3","perl","php","ruby",
  "curl","wget","nc","ncat","socat","ssh"
]);

// Staging / in-memory hints (these may appear in cmdlines/scripts; not guaranteed)
let StagingSignals = dynamic([
  "Invoke-Expression","IEX","Invoke-WebRequest","EncodedCommand","FromBase64String",
  "AmsiScanBuffer","AmsiUtils","System.Management.Automation",
  "curl http","wget http","curl|bash","curl | bash","wget -O - | bash",
  "bash -c","sh -c",
  "child_process.exec","child_process.spawn","vm.runInThisContext","eval("
]);

// Sensitive file names often targeted for creds/secrets (names only)
let SensitiveFileHints = dynamic([
  ".env",".npmrc",".aws/credentials",".ssh/id_rsa","config.json","id_rsa","known_hosts",
  ".bashrc",".zshrc",".profile"
]);

// Extensions that often represent payload/persistence staging
let MaliciousExtensions = dynamic([
  ".ps1",".bat",".cmd",".vbs",".js",".jse",".sh",".py",".pl",".php",".jar",".jsp",
  ".exe",".dll",".so"
]);

// Allowlist blocks included for parity (disabled here)
let AllowedParentCmdlinePatterns = dynamic(["npm install","npm ci","npm run build","yarn install","yarn build","pnpm install","pnpm build","webpack","vite","react-scripts","next build","gulp","grunt"]);
let AllowedPaths = dynamic(["\\agent\\_work\\","\\actions\\runner\\","/home/runner/","/var/lib/jenkins/","/build/","/workspace/"]);
let AllowedAccounts = dynamic(["svc-azure-devops","svc-github-runner","svc-jenkins","buildagent","runner"]);
let IsAllowlisted = (
  EnableAllowlist
  and (
    InitiatingProcessCommandLine has_any (AllowedParentCmdlinePatterns)
    or FolderPath has_any (AllowedPaths)
    or AccountName has_any (AllowedAccounts)
  )
);

// ---------------------------------------------------------------------------
// 1) PROC: Runtime/Web parent spawns suspicious child + staging hints
//    Why: This is the most common, EDR-visible post-exploitation side-effect.
// ---------------------------------------------------------------------------
let Proc =
DeviceProcessEvents
| where Timestamp >= ago(lookback)
| where InitiatingProcessFileName has_any (ParentProc)
| where FileName has_any (ChildProc)
| where not(IsAllowlisted)
| extend Cmd = tostring(ProcessCommandLine)
| extend HasStaging = Cmd has_any (StagingSignals)
| extend HasPipeToShell = Cmd matches regex @"(curl\s+\S+.*\|\s*(ba|z|da)?sh)|(wget\s+.+\|\s*(ba|z|da)?sh)"
| extend B64 = extract_all(@"[A-Za-z0-9+/]{40,}={0,2}", Cmd)
| extend HasB64 = array_length(B64) > 0
| extend ProcScore =
    40
  + iif(HasStaging, 25, 0)
  + iif(HasPipeToShell, 35, 0)
  + iif(HasB64, 15, 0)
| project
    ProcTs=Timestamp, DeviceId, DeviceName, AccountName,
    Parent=InitiatingProcessFileName, ParentCmd=InitiatingProcessCommandLine,
    Child=FileName, Cmd, ProcScore, HasStaging, HasPipeToShell, HasB64;

// ---------------------------------------------------------------------------
// 2) NET: Runtime/Web parent makes suspicious connections (delivery/C2/exfil)
//    Why: Exploit delivery and follow-on C2 often manifest as outbound net.
// ---------------------------------------------------------------------------
let Net =
DeviceNetworkEvents
| where Timestamp >= ago(lookback)
| where InitiatingProcessFileName has_any (ParentProc)
| where ActionType in ("ConnectionSuccess","InboundConnectionAccepted","ListeningConnectionCreated")
| extend Remote = coalesce(RemoteUrl, RemoteIP)
| extend RemoteUrlIndicators = RemoteUrl has_any (dynamic(["pastebin","discord","telegram","ngrok","trycloudflare","onion"]))
| extend RemoteIpNonPrivate = iff(isnotempty(RemoteIP), not(ipv4_is_private(RemoteIP)), bool(null))
| extend HighRiskPort = RemotePort in (4444, 1337, 2222, 3001, 4443, 8080, 8443, 9001, 31337)
| extend NetScore =
    20
  + iif(RemoteUrlIndicators, 20, 0)
  + iif(HighRiskPort and RemoteIpNonPrivate == true, 30, 0)
| project
    NetTs=Timestamp, DeviceId, DeviceName, AccountName,
    Parent=InitiatingProcessFileName, ParentCmd=InitiatingProcessCommandLine,
    RemoteIP, RemotePort, RemoteUrl, LocalPort, Protocol, ActionType, NetScore;

// ---------------------------------------------------------------------------
// 3) FILE: Runtime/Web parent touches sensitive files or writes payload-like files
//    Why: Secrets theft + persistence staging are highly indicative.
// ---------------------------------------------------------------------------
let Files =
DeviceFileEvents
| where Timestamp >= ago(lookback)
| where InitiatingProcessFileName has_any (ParentProc)
| where ActionType in ("FileCreated","FileModified","FileRenamed")
| extend Path = tostring(FolderPath)
| extend Name = tostring(FileName)
| extend HasSensitiveName = Name has_any (SensitiveFileHints)
| extend HasMaliciousExt = Name has_any (MaliciousExtensions)
| extend HasTempOrHidden =
    Path has_any (dynamic(["\\Temp\\","\\AppData\\Local\\Temp\\","/tmp/","/var/tmp/","/.cache/"]))
    or Name startswith "."
| extend FileScore =
    10
  + iif(HasSensitiveName, 45, 0)
  + iif(HasMaliciousExt and HasTempOrHidden, 30, 0)
| project
    FileTs=Timestamp, DeviceId, DeviceName, AccountName,
    Parent=InitiatingProcessFileName, ParentCmd=InitiatingProcessCommandLine,
    FolderPath, FileName, FileScore, HasSensitiveName, HasTempOrHidden, HasMaliciousExt;

// ---------------------------------------------------------------------------
// 4) CHAIN: Correlate into a single “chain record” per window (hunt-friendly)
// ---------------------------------------------------------------------------
Proc
| join kind=leftouter (Net) on DeviceId, AccountName, Parent
| where NetTs between (ProcTs - ChainWindow .. ProcTs + ChainWindow) or isempty(NetTs)
| join kind=leftouter (Files) on DeviceId, AccountName, Parent
| where FileTs between (ProcTs - ChainWindow .. ProcTs + ChainWindow) or isempty(FileTs)
| extend TotalScore = ProcScore + coalesce(NetScore,0) + coalesce(FileScore,0)
| extend ChainBucket = bin(ProcTs, ChainWindow)
| summarize
    FirstSeen=min(ProcTs),
    LastSeen=max(ProcTs),
    Parents=make_set(Parent, 5),
    ParentCmds=make_set(ParentCmd, 10),
    Children=make_set(Child, 25),
    CommandLines=make_set(Cmd, 25),
    Remotes=make_set(coalesce(RemoteUrl, RemoteIP), 25),
    RemotePorts=make_set(tostring(RemotePort), 25),
    FileTouches=make_set(strcat(FolderPath,"\\",FileName), 25),
    MaxScore=max(TotalScore),
    Signals=make_set(
      strcat(
        iif(HasStaging,"Staging;",""),
        iif(HasPipeToShell,"PipeToShell;",""),
        iif(HasB64,"Base64;",""),
        iif(HasSensitiveName,"SensitiveFileName;",""),
        iif(HasTempOrHidden,"TempOrHiddenWrite;",""),
        iif(HasMaliciousExt,"MaliciousExtensionWrite;","")
      ), 10
    )
  by ChainBucket, DeviceName, AccountName
| extend Severity = case(
    MaxScore >= 100, "CRITICAL",
    MaxScore >= 75,  "HIGH",
    MaxScore >= 50,  "MEDIUM",
    "LOW"
)
| extend HuntingDirectives = case(
    Severity == "CRITICAL",
      "CRITICAL: Runtime/Web parent chained to suspicious exec + corroborating net/file signals. Pivot: DeviceProcessEvents (children), DeviceNetworkEvents (remote), DeviceFileEvents (staging). Consider isolate if C2/exfil/persistence indicated.",
    Severity == "HIGH",
      "HIGH: Validate if this host is a CI/build agent or dev box. If not expected, scope for follow-on persistence (cron/systemd/tasks/services) and secrets access (.env/.ssh).",
    Severity == "MEDIUM",
      "MEDIUM: Baseline the parent runtime and typical child processes for this tenant. Pivot to network/file evidence to confirm intent.",
      "LOW: Weak signal; keep for baselining. Promote only if repeated or corroborated."
)
| order by FirstSeen desc
;

// ============================================================================
// INCIDENT RESPONSE FRAMEWORK — React / Node.js Runtime Post-Exploitation
// Commented for analyst guidance only (non-executing)
// ============================================================================
//
// PHASE 1 — TRIAGE & VALIDATION (L2/L3)
// 1) Confirm parent context (node/w3wp/java/dotnet) and whether host is dev/CI.
// 2) Validate child intent (shell/LOLBins, pipe-to-shell, base64).
// 3) Corroborate: outbound net + sensitive file touches.
//
// PHASE 2 — SCOPING & THREAT ASSESSMENT
// 4) Scope device for additional runtime-spawned children + repeat chains.
// 5) Scope account (service acct? used elsewhere?).
// 6) Assess privilege (root/SYSTEM/container).
//
// PHASE 3 — CONTAINMENT
// 7) Isolate if C2/reverse-shell/exfil/persistence strongly indicated.
// 8) Block exposure: stop dev servers, restrict inbound ports, tighten SG/WAF.
//
// PHASE 4 — ERADICATION & REMEDIATION
// 9) Remove persistence: cron/systemd/services/tasks/startup scripts.
// 10) Rotate secrets: .env, API keys, cloud creds, SSH keys.
// 11) Harden: dev servers not internet-exposed, disable HMR outside localhost.
//
// PHASE 5 — POST-INCIDENT
// 12) Tune allowlists (per tenant): runner paths/accounts/known build patterns.
// 13) Capture IOCs/TTPs and feed back into hunts + SDLC guardrails.
// ============================================================================
