// ============================================================================
// L3_ReactDevServer_PostExploitation_Chain (Windows + Linux)
// Author: Ala Dabat
// Goal: Runtime/Web parent → suspicious child exec OR suspicious outbound net
//       + staging indicators + optional persistence/file-write side-effects
// Notes: Exploit/HMR in-memory is not directly visible; we detect side-effects.
// MITRE: TA0002, TA0003, TA0005, TA0011 (Execution, Persistence, Defense Evasion, C2)
// ============================================================================

let lookback = 7d;
let ChainWindow = 10m;

let ParentProc = dynamic(["node.exe","node","w3wp.exe","iisexpress.exe","httpd.exe","nginx.exe","java.exe","dotnet.exe","gunicorn","uwsgi"]);
let ChildProc = dynamic([
  "powershell.exe","pwsh.exe","cmd.exe","mshta.exe","wscript.exe","cscript.exe",
  "rundll32.exe","regsvr32.exe","certutil.exe",
  "sh","bash","dash","zsh","python","python3","perl","php","ruby","curl","wget","nc","ncat","socat","ssh"
]);

// Staging + runtime-exec hints (only indicators; not “how-to”)
let StagingSignals = dynamic([
  "Invoke-Expression","IEX","Invoke-WebRequest","EncodedCommand","FromBase64String",
  "AmsiScanBuffer","AmsiUtils","System.Management.Automation",
  "curl http","wget http","curl|bash","curl | bash","wget -O - | bash",
  "bash -c","sh -c",
  "child_process.exec","child_process.spawn","vm.runInThisContext","eval("
]);

// “Interesting file targets” (exfil/persistence) - names only
let SensitiveFileHints = dynamic([".env",".npmrc",".aws/credentials",".ssh/id_rsa","config.json","id_rsa","known_hosts"]);

// --- 1) Runtime/Web parent spawning suspicious children
let Proc = DeviceProcessEvents
| where Timestamp >= ago(lookback)
| where InitiatingProcessFileName has_any (ParentProc)
| where FileName has_any (ChildProc)
| extend Cmd = tostring(ProcessCommandLine)
| extend HasStaging = Cmd has_any (StagingSignals)
| extend HasPipeToShell = Cmd matches regex @"(curl\s+\S+.*\|\s*(ba|z|da)?sh)|(wget\s+.+\|\s*(ba|z|da)?sh)"
| extend B64 = extract_all(@"[A-Za-z0-9+/]{40,}={0,2}", Cmd)
| extend HasB64 = array_length(B64) > 0
| extend ProcScore =
    40
  + iif(HasStaging, 25, 0)
  + iif(HasPipeToShell, 25, 0)
  + iif(HasB64, 15, 0)
| project
    Timestamp, DeviceId, DeviceName, AccountName,
    Parent=InitiatingProcessFileName, ParentCmd=InitiatingProcessCommandLine,
    Child=FileName, Cmd, ProcScore, HasStaging, HasPipeToShell, HasB64;

// --- 2) Outbound network from the same runtime/web parent (delivery/C2/exfil)
let Net = DeviceNetworkEvents
| where Timestamp >= ago(lookback)
| where InitiatingProcessFileName has_any (ParentProc)
| where ActionType in ("ConnectionSuccess","InboundConnectionAccepted","ListeningConnectionCreated")
| extend Remote = coalesce(RemoteUrl, RemoteIP)
| extend NetScore =
    20
  + iif(RemoteUrl has_any (dynamic(["pastebin","discord","telegram","ngrok","trycloudflare","onion"])), 20, 0)
| project
    Timestamp, DeviceId, DeviceName, AccountName,
    Parent=InitiatingProcessFileName, ParentCmd=InitiatingProcessCommandLine,
    RemoteIP, RemotePort, RemoteUrl, LocalPort, Protocol, ActionType, NetScore;

// --- 3) Optional: file writes by runtime/web parent (persistence/exfil staging)
let Files = DeviceFileEvents
| where Timestamp >= ago(lookback)
| where InitiatingProcessFileName has_any (ParentProc)
| where ActionType in ("FileCreated","FileModified","FileRenamed")
| extend Path = tostring(FolderPath)
| extend Name = tostring(FileName)
| extend HasSensitiveName = Name has_any (SensitiveFileHints)
| extend HasTempOrHidden =
    Path has_any (dynamic(["\\Temp\\","\\AppData\\Local\\Temp\\","/tmp/","/var/tmp/","/.cache/"]))
    or Name startswith "."
| extend FileScore = 10 + iif(HasSensitiveName, 25, 0) + iif(HasTempOrHidden, 15, 0)
| project
    Timestamp, DeviceId, DeviceName, AccountName,
    Parent=InitiatingProcessFileName, ParentCmd=InitiatingProcessCommandLine,
    FolderPath, FileName, FileScore, HasSensitiveName, HasTempOrHidden;

// --- 4) Chain correlation (single record per window)
Proc
| join kind=leftouter (
    Net
) on DeviceId, AccountName, Parent
| where Net.Timestamp between (Proc.Timestamp - ChainWindow .. Proc.Timestamp + ChainWindow) or isempty(Net.Timestamp)
| join kind=leftouter (
    Files
) on DeviceId, AccountName, Parent
| where Files.Timestamp between (Proc.Timestamp - ChainWindow .. Proc.Timestamp + ChainWindow) or isempty(Files.Timestamp)
| extend TotalScore = ProcScore + coalesce(NetScore,0) + coalesce(FileScore,0)
| extend ChainBucket = bin(Proc.Timestamp, ChainWindow)
| summarize
    FirstSeen=min(Proc.Timestamp),
    LastSeen=max(Proc.Timestamp),
    Parents=make_set(Parent, 5),
    Children=make_set(Child, 25),
    CommandLines=make_set(Cmd, 25),
    Remotes=make_set(coalesce(RemoteUrl, RemoteIP), 25),
    RemotePorts=make_set(tostring(RemotePort), 25),
    FileTouches=make_set(strcat(FolderPath,"\\",FileName), 25),
    MaxScore=max(TotalScore),
    Signals=make_set(
      strcat(
        iif(HasStaging,"Staging;",""),
        iif(HasPipeToShell,"PipeToShell;",""),
        iif(HasB64,"Base64;",""),
        iif(HasSensitiveName,"SensitiveFileName;",""),
        iif(HasTempOrHidden,"TempOrHiddenWrite;","")
      ), 10
    )
  by ChainBucket, DeviceName, AccountName
| extend Severity = case(
    MaxScore >= 95, "CRITICAL",
    MaxScore >= 70, "HIGH",
    MaxScore >= 45, "MEDIUM",
    "LOW"
)
| extend ThreatHunterDirective = case(
    Severity == "CRITICAL", "CRITICAL – Runtime/Web process chained to suspicious exec + corroborating net/file signals. Consider isolate + scope for creds/exfil.",
    Severity == "HIGH",     "HIGH – Runtime/Web process spawned suspicious child or showed staging, with supporting context. Hunt for follow-on persistence + external beacons.",
    Severity == "MEDIUM",   "MEDIUM – Runtime/Web process suspicious child activity. Validate if dev tooling is expected; pivot to network + file events for proof.",
    "LOW – Weak signal; keep for hunting and baselining."
)
| order by FirstSeen desc

// ============================================================================
// INCIDENT RESPONSE FRAMEWORK — React / Node.js Runtime Post-Exploitation
// This section is COMMENTED OUT and intended for SOC analyst guidance only.
// It does NOT execute as part of the detection logic.
// ============================================================================
//
// CONTEXT:
// This alert indicates suspicious post-exploitation behavior originating from
// a web/runtime process (e.g., node, w3wp, java, dotnet). In-memory exploitation
// (e.g., Webpack HMR / eval / vm.runInThisContext) is typically NOT directly
// observable via EDR; this detection relies on post-execution side-effects.
//
// ============================================================================
// PHASE 1 — TRIAGE & VALIDATION (L2/L3)
// ============================================================================
//
// 1. Confirm Parent Context
//    - Verify the parent process:
//        * node.exe / node
//        * w3wp.exe / iisexpress.exe
//        * java / dotnet
//    - Determine if this host is EXPECTED to run:
//        * React dev servers
//        * CI/CD runners
//        * build agents
//    - Red Flag:
//        * Internet-facing dev servers
//        * node running as root / SYSTEM
//
// 2. Validate Child Execution
//    - Review spawned child processes:
//        * bash / sh / cmd / powershell
//        * curl / wget / nc / ssh
//    - Assess command intent:
//        * Pipe-to-shell (curl | bash)
//        * Base64 blobs / EncodedCommand
//        * Direct execution of scripting engines
//
// 3. Corroborate Supporting Signals
//    - Outbound network connections:
//        * External IPs/domains
//        * Unusual ports (not 80/443 or expected SaaS)
//    - File activity:
//        * Writes to /tmp, /var/tmp, AppData\\Temp
//        * Creation of hidden files (.env, .cache, .system*)
//        * Access to sensitive files (.env, .ssh, cloud creds)
//
// ============================================================================
// PHASE 2 — SCOPING & THREAT ASSESSMENT
// ============================================================================
//
// 4. Scope the Host
//    - Pivot by DeviceId to find:
//        * Other suspicious child processes
//        * Additional outbound connections
//        * Repeated execution patterns
//
// 5. Scope the Account
//    - Pivot by AccountName:
//        * Is this a service account?
//        * Has this account executed similar commands elsewhere?
//
// 6. Assess Privilege Level
//    - Determine runtime privileges:
//        * node running as root / SYSTEM = HIGH RISK
//        * container escape risk if Docker/K8s
//
// ============================================================================
// PHASE 3 — CONTAINMENT (IF CONFIRMED OR HIGH CONFIDENCE)
// ============================================================================
//
// 7. Immediate Containment (CRITICAL/HIGH)
//    - Isolate the host via EDR if ANY of the following are true:
//        * Confirmed reverse shell / C2
//        * Credential access or exfiltration detected
//        * Persistence artifacts identified
//
// 8. Application-Level Containment
//    - Stop exposed dev servers immediately:
//        * npm start / webpack-dev-server
//        * hot-reload / HMR endpoints
//    - Block inbound access at:
//        * Firewall
//        * Reverse proxy
//        * Cloud security group
//
// ============================================================================
// PHASE 4 — ERADICATION & REMEDIATION
// ============================================================================
//
// 9. Remove Persistence
//    - Check and remove:
//        * cron / systemd services (Linux)
//        * scheduled tasks / services (Windows)
//        * modified startup scripts
//
// 10. Credential Hygiene
//    - Rotate credentials if accessed:
//        * .env secrets
//        * API keys
//        * Cloud credentials
//        * SSH keys
//
// 11. Patch & Harden
//    - Ensure:
//        * Dev servers are NOT internet-exposed
//        * NODE_ENV=production for prod workloads
//        * HMR disabled outside localhost
//        * Access restricted via VPN / allowlists
//
// ============================================================================
// PHASE 5 — POST-INCIDENT ACTIONS
// ============================================================================
//
// 12. Detection Improvements
//    - Add allowlists for:
//        * Approved CI/CD build agents
//        * Known internal dev tooling
//    - Consider additional detections:
//        * Internet-facing dev servers
//        * node spawning shells without network context
//
// 13. Threat Intel & Lessons Learned
//    - Capture:
//        * IOCs (domains, IPs, hashes)
//        * TTPs observed (MITRE mapping)
//    - Feed findings into:
//        * Threat hunting backlog
//        * Secure SDLC guidance
//
// ============================================================================
// ANALYST NOTE:
// Exploitation may have occurred entirely in-memory. Absence of exploit logs
// does NOT equal absence of compromise. Base decisions on behavioral evidence.
// ============================================================================
