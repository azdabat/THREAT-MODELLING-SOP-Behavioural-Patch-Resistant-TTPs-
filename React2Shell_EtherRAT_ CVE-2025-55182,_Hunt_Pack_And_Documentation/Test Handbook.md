# L3 Analyst Handbook – Unified Threat Detection Framework
## Rust4Shell + EtherRAT (IDE/Extension Abuse & Blockchain RPC Correlation)

**Author:** Ala Dabat (azdabat)  
**Version:** 2025-L3-Ultimate  
**Repository:** Core-Threat-Hunts  
**Classification:** TLP:CLEAR / Operational Guidance

---

## 1. Purpose & Audience
This handbook serves as the operational "Single Source of Truth" for L3 SOC Analysts and Threat Hunters. It addresses the 2024-2025 shift toward **Rust-based web exploitation** and **Web3-infrastructure-as-C2**.

* **Rust4Shell:** Post-RCE behavior targeting modern frameworks (Actix, Rocket, Axum).
* **EtherRAT:** Implants leveraging Blockchain RPC (Infura, Alchemy) for stealth command relay.
* **IDE Abuse:** Supply-chain compromise bridging dev-tools to production access.

---

## 2. Combined Threat Ecosystem (Mermaid)

```mermaid
flowchart TD
    subgraph Initial_Access
    A[Exploit: Rust4Shell / Actix-Web] -->|Process Pivot| B[Web Shell Spawned]
    A -->|Supply Chain| C[Malicious IDE Extension]
    end

    subgraph Post_Exploitation
    B --> D{Staging & Evasion}
    C --> D
    D -->|KQL: Proc| E[AMSI Bypass / B64 Payloads]
    D -->|KQL: Net| F[curl | bash / Ingress Transfer]
    end

    subgraph C2_and_Exfil
    E --> G[Secrets Recon: .env / id_rsa]
    F --> G
    G --> H[EtherRAT Deployment]
    H -->|KQL: RPC| I[Blockchain RPC C2: Infura/Alchemy]
    I --> J[Exfiltration / Lateral Movement]
    end

    style I fill:#f96,stroke:#333,stroke-width:2px
```

---

## 3. L3 Behavioural Detection Matrix

| Tactic | Behavioural Signal | MITRE | L3 Strategic Note |
| :--- | :--- | :--- | :--- |
| **Execution** | Web Runtime → Shell Pivot | T1190 / T1059 | P1 if context is Web Root or Service Account. |
| **Defense Evasion** | AMSI Bypass / Ghost Modules | T1562.001 | High intent; indicates bypass of host-based controls. |
| **Supply Chain** | IDE Extension File Drop | T1195 | Monitor `~/.vscode/extensions/` for unsigned `.so/.dll`. |
| **C2** | Outbound Blockchain RPC | T1102.002 | Uses Infura/Alchemy as dead-drops to bypass firewalls. |
| **Exfiltration** | Secrets Recon via `find/grep` | T1552 | Precedes credential theft of AWS/GitHub/Production keys. |

---

## 4. Master KQL Pivot Kits (Sentinel / MDE)

### 4.1 Hunt 1: Web Process → Shell Post-Exploitation (React2Shell/Rust4Shell)
This query identifies web servers spawning interactive shells with staging/evasion indicators.

```kql
let ParentProc = dynamic(["node.exe", "node", "w3wp.exe", "iisexpress.exe", "httpd.exe", "nginx.exe", "java.exe", "dotnet.exe", "actix-web", "rocket"]);
let StagingSignals = dynamic(["Invoke-Expression", "IEX", "Invoke-WebRequest", "EncodedCommand", "AmsiScanBuffer", "AmsiUtils", "Reflection.Assembly", "curl http", "wget http", "curl|bash", "bash -c", "sh -c"]);
DeviceProcessEvents
| where InitiatingProcessFileName has_any (ParentProc)
| where FileName in~ ("powershell.exe", "pwsh.exe", "cmd.exe", "sh", "bash", "python", "curl", "wget")
| where ProcessCommandLine has_any (StagingSignals) or ProcessCommandLine matches regex @"(curl\s.+\|\s*bash)|(wget\s.+\|\s*bash)"
| extend AmsiHits = extract_all(@"(AmsiScanBuffer|AmsiUtils|System\.Management\.Automation)", ProcessCommandLine)
| extend B64 = extract_all(@"[A-Za-z0-9+/]{40,}={0,2}", ProcessCommandLine)
| summarize CommandLines = make_set(ProcessCommandLine), Amsi = make_set(AmsiHits), B64Blobs = make_set(B64) by Timestamp, DeviceName, InitiatingProcessFileName, AccountName
| extend TotalIndicators = array_length(Amsi) + array_length(B64Blobs)
| extend ThreatHunterDirective = case(
      TotalIndicators >= 2, "CRITICAL – Web Process -> Shell -> AMSI/Decode Detected",
      TotalIndicators == 1, "HIGH – Web Process -> Shell + Staging Indicators",
      "MEDIUM – Abnormal Web Server Shell Activity")
| order by Timestamp desc
```

### 4.2 Hunt 2: Blockchain RPC C2 Correlation (EtherRAT)
Detects non-browser processes (Implants) communicating with Web3 infrastructure.

```kql
let RPCProviders = dynamic(["infura.io", "alchemy.com", "quicknode.com", "solana-mainnet", "polygon-rpc.com", "avax.network"]);
DeviceNetworkEvents
| where Timestamp > ago(7d)
| where RemoteUrl has_any (RPCProviders)
| where InitiatingProcessFileName !in~ ("chrome.exe", "firefox.exe", "msedge.exe", "brave.exe")
| summarize FirstSeen=min(Timestamp), TotalConnections=count() by DeviceId, DeviceName, InitiatingProcessFileName, RemoteUrl, RemotePort
| where TotalConnections > 5 
| extend ThreatHunterDirective = "P1: Validate if Process is a Dev Tool. If unknown binary, assume EtherRAT C2."
| order by TotalConnections desc
```

### 4.3 Hunt 3: IDE Extension Abuse & Ghost Module Loading
Detects malicious extensions dropping payloads or executing shells.

```kql
DeviceProcessEvents
| where Timestamp > ago(30d)
| where FolderPath contains @".vscode\extensions\" 
    or FolderPath contains @".config/Code/"
    or FolderPath contains @"Library/Application Support/Code/"
| where FileName in~ ("node", "python", "bash", "sh", "powershell", "curl")
| summarize Count=count(), Devices=dcount(DeviceId) by FileName, CommandLine, FolderPath
| extend ThreatHunterDirective = "P2: Audit Extension Publisher. Check for unsigned .so/.dll drops in these paths."
```

---

## 5. Investigation Playbook (L3 Triage)

### 5.1 The 5-Minute Rule
If you cannot verify the legitimacy of a **Web Server → Shell** pivot or **Unsigned Binary → RPC** connection within 5 minutes, proceed to **Isolation**.

### 5.2 Escalation Matrix
| Scenario | Action |
| :--- | :--- |
| **Confirmed Web Shell + RPC** | **P1:** Isolate Host + Revoke Service Acct Tokens. |
| **IDE Abuse on Non-Dev Host** | **P1:** Immediate containment; check for lateral movement. |
| **Secrets Recon (`grep .env`)** | **P2:** Verify if Admin activity. If not, rotate all keys. |

---

## 6. Appendix: Detailed Attack explanation

### 6.1 Rust4Shell (Modern RCE)
Targets memory-safe languages that are often neglected in monitoring. Attackers exploit **deserialization flaws** in Rust `serde` or logic errors in `unsafe` Rust blocks. 

### 6.2 EtherRAT (Web3 Implant)
EtherRAT is a cross-platform (Rust/Go) implant. Its primary innovation is using **Smart Contract Storage** as a dead-drop.
1.  **Victim** polls `eth_getStorageAt`.
2.  **Contract** returns an encoded string.
3.  **Victim** decodes string into an OS command (e.g., `download exfil_tool`).

---

## 7. Response Playbook Quick Reference
1.  **Contain:** Isolate Host (EDR).
2.  **Block:** Null-route RPC API keys and block Infura/Alchemy at the Proxy.
3.  **Audit:** Identify all `.env` and `id_rsa` files touched by the compromised PID.
4.  **Eradicate:** Global uninstall of the malicious VSCode/JetBrains extension ID.

**END – Unified Rust4Shell + EtherRAT L3 Handbook**
