// ===============================
// React2Shell Post-Exploitation Detection Rule
// Windows + Linux
// Author: Ala Dabat
// ===============================

let ParentProc = dynamic(["node.exe","w3wp.exe","iisexpress.exe","httpd.exe","nginx.exe","java.exe","dotnet.exe"]);

let ChildProc = dynamic([
    "powershell.exe","pwsh.exe","cmd.exe","mshta.exe","wscript.exe","cscript.exe",
    "rundll32.exe","regsvr32.exe","certutil.exe","sh","bash","python","python3","perl","php","curl","wget"
]);

let StagingSignals = dynamic([
    "Invoke-Expression","IEX","Invoke-WebRequest","EncodedCommand",
    "FromBase64String","AmsiScanBuffer","AmsiUtils","Reflection.Assembly",
    "curl http","wget http","curl|bash","curl | bash","wget -O - | bash",
    "bash -c","sh -c"
]);

DeviceProcessEvents
| where InitiatingProcessFileName has_any (ParentProc)
| where FileName has_any (ChildProc)
| where ProcessCommandLine has_any (StagingSignals)
      or ProcessCommandLine matches regex @"(curl\s.+\|\s*bash)|(wget\s.+\|\s*bash)"
| extend AmsiHits = extract_all(@"(AmsiScanBuffer|AmsiUtils|System\.Management\.Automation)", ProcessCommandLine)
| extend B64 = extract_all(@"[A-Za-z0-9+/]{40,}={0,2}", ProcessCommandLine)
| summarize
      CommandLines = make_set(ProcessCommandLine),
      Amsi = make_set(AmsiHits),
      B64Blobs = make_set(B64)
  by Timestamp, DeviceName, InitiatingProcessFileName, AccountName
| extend TotalIndicators = array_length(Amsi) + array_length(B64Blobs)
| extend ThreatHunterDirective = case(
      TotalIndicators >= 2, "CRITICAL – Web Process → Shell → AMSI/Decode Detected",
      TotalIndicators == 1, "HIGH – Web Process → Shell + Staging Indicators",
      "MEDIUM – Abnormal Web Server Shell Activity"
)
| order by Timestamp desc
