# L3 Analyst Handbook – Unified Threat Detection Framework  
## Rust4Shell + EtherRAT (with IDE / Extension abuse and RPC correlation)

Author: **Ala Dabat (azdabat)**  
Version: **2025-L3**  
Repository: **Core-Threat-Hunts**

---

## Table of Contents
1. Purpose & Audience
2. Behavioural Detection Philosophy (L3 Focus)
3. Combined Threat Ecosystem & Diagrams
4. Deep Behavioural Notes per Detection Rule
5. Correlation & High‑Value Signal Flow
6. Detailed attack explanation: Rust4Shell + EtherRAT
7. MITRE mapping by attack stage
8. L3 Pivot Guidance
9. Appendix A — High‑Value Signals
10. Appendix B — Suppression vs Escalation Rules
11. Appendix C — Advanced KQL Pivot Kits

---

## 1. Purpose & Audience

This handbook is a **single source of truth** for L3 analysts, threat hunters, and detection engineers working on:

- Rust4Shell‑class web exploitation and post‑RCE behaviour  
- EtherRAT‑style implants and Web3‑aware supply‑chain compromise  
- IDE/extension abuse pathways bridging development tools with adversary C2  
- High‑fidelity correlation hunts that reduce noise and raise P1 decisions  

It is designed to be copied directly to GitHub and used as operational guidance in production SOC environments.

---

## 2. Behavioural Detection Philosophy (L3 Focus)

### 2.1 Execution Context > Indicators
A command line alone means little; **who spawns it, from where, and under what context** is critical.

### 2.2 Cross‑family behavioural clusters
React2Shell‑style or Rust4Shell‑style web exploitation and EtherRAT implants share strong post‑exploit behaviours:
- web → shell pivots
- staging and obfuscation
- secrets discovery
- userland loaders
- RPC‑style C2
Therefore hunts are modular but interlinked.

### 2.3 Intent signals trump single indicators
Key signals that prove:
- evasion  
- staging  
- credential theft  
- stealth loaders  
- unauthorized outbound C2  
are prioritized over mere presence of known tools.

---

## 3. Combined Threat Ecosystem & Diagrams

### 3.1 Unified ASCII Attack Path

```
            [Web Exploit / Rust4Shell]
                         ↓
              [Web → Shell Pivot]
                         ↓
                ┌────────┴─────────┐
                │                  │
       [Staging: curl | iwr]  [Obfuscation: AMSI + Base64]
                │                  │
                └────────┬─────────┘
                         │
                [Secrets Recon / File Discovery]
                         │
                [Userland Loader Deployment]
                         │
              [IDE / Extension Abuse / Rust Loader]
                         │
            [Blockchain RPC / Web3 C2 Beacon]
                         │
                [Persistence / Lateral Movement]
```

### 3.2 Unified Mermaid Ecosystem Diagram

```mermaid
flowchart TD
    A[Web Exploit / Rust4Shell] --> B[Web → Shell Pivot]
    B --> C[Staging: curl | iwr]
    B --> D[Obfuscation: AMSI + Base64]

    C --> E[Secrets Recon / File Discovery]
    D --> E

    E --> F[Userland Loader Deployment]
    F --> G[IDE / Extension Abuse / Rust Loader]
    G --> H[Blockchain RPC / Web3 C2 Beacon]

    H --> I[Persistence / Lateral Movement]
```
---

## 4. Deep Behavioural Notes per Detection Rule

Below are L3‑only explanations: what the rule detects, why it matters, adversary intention, and environment‑specific risk.

### 4.1 WebRCE_ProcessPivot (RCE Core)
- Detects web server runtimes spawning shells unexpectedly.
- High‑risk because this is direct evidence of remote code execution from a public‑facing or internal web app.
- Severity ranges from P2 (suspicion) to P1 (strong indicators like dangerous flags, shell types, web root context).
- Typical MITRE techniques: **T1190** exploit public‑facing apps, **T1059** command or scripting execution. External references note that multiple groups (e.g., APT29, others) have used public‑facing exploits for access. :contentReference[oaicite:0]{index=0}

### 4.2 WebRCE_Staging (Ingress Tool Transfer)
- Detects staged retrieval of tooling, often via `curl|bash` or similar pipe‑to‑shell operations.
- Fileless loaders are severe: immediate next step after RCE; minimal artifact left on disk.
- MITRE technique: **T1105** ingress tool transfer; also linked to command & control in behaviour.
- High confidence if URL looks suspicious or pipe‑to‑shell used; medium if simple download.

### 4.3 Obfuscation / AMSI Bypass
- Detects encoded payloads, AMSI bypass strings, reflection, or long Base64.
- Indicates active evasion; core signal of an operator who wants to defeat detection.
- MITRE technique: **T1562.001** for AMSI bypass, **T1027** for obfuscation.
- Very strong signal, often escalated to P1 for immediate review, decoding, and correlation.

### 4.4 Secrets Recon (Behavioural discovery)
- Detects search behaviour for password files, keys, tokens, etc., using `grep`, `findstr`, `Select-String`, etc.
- Phase often precedes exfiltration; broad coverage across windows/linux.
- MITRE techniques: **T1081**, **T1552**.
- Scoring emphasises when content search and password keywords used recursively, reduced noise from admin paths.

### 4.5 IDE / Extension Abuse (Execution)
- Detects execution of shells or scripts in IDE extension contexts; hardened to exclude integrated terminals and known benign toolchains.
- Further boosted when ghost module loads are detected (unsigned/invalid modules from extension paths).
- MITRE techniques: **T1195** supply chain compromise, **T1059** execution, **T1027** obfuscation or **T1574** hijack execution flow.
- P1 if both malicious behaviour and ghost module loads exist.

### 4.6 IDE Extension File Drop
- Detects binary or script drops into extension storage folders.
- Highlights supply‑chain staging where a malicious extension places payloads for later execution.
- MITRE: **T1195**, **T1105**, **T1059**.
- Strong P1 when binary or module dropped.

### 4.7 IDE Extension Persistence
- Detects manipulation of extension config or state files indicating persistence.
- MITRE: **T1547** autostart or persistence, **T1195** supply chain.
- P1 for direct state or settings changes in extension context.

### 4.8 Userland Unsigned Binary (Loader/Implant)
- Detects unsigned binaries executed from user path (Temp, AppData, Downloads) with suspicious args.
- Generic loader detection ideal for modern implants (Rust, etc.).
- MITRE: **T1059**, **T1204** user execution.
- P1 if non‑dev host and suspicious flags; P2 if dev host but suspicious context.

### 4.9 Blockchain RPC C2
- Detects use of Web3 RPC endpoints by any process; boosted if repeated beacons or non‑dev host.
- MITRE: **T1102** web service C2; detection strategy described by MITRE for abnormal web service use. :contentReference[oaicite:1]{index=1}
- P1 if correlation or high frequency; P2 if context uncertain.

### 4.10 IDE Abuse → Blockchain RPC Correlation
- High‑fidelity P1 correlation: IDE abuse followed by RPC use within 24 hours; not a replacement for RPC rule.
- Creates concrete narrative for EtherRAT or similar implants.

---

## 5. Correlation & High‑Value Signal Flow

### 5.1 When to escalate to P1
- Web → Shell plus staging or obfuscation in same host.
- IDE extension abuse plus ghost module load.
- IDE abuse or file drop plus blockchain RPC within 24 hours.
- Secrets recon plus userland unsigned binary or RPC use.
- Any of the above on a non‑dev host, or beyond known pipelines.

### 5.2 How hunts connect
- WebRCE → Staging/Obfuscation → SecretsRecon → Loader → IDE/Extension Abuse → RPC → Persistence.
- Each rule outputs severity, hunter directives, and MITRE mapping; analysts pivot per guidelines.

---

## 6. Detailed attack explanation: Rust4Shell + EtherRAT

### 6.1 What is Rust4Shell?
- A hypothetical or conceptual Web exploitation chain similar to React2Shell, but focused on Rust or modern web servers.
- Exploits a deserialization or server‑side vulnerability allowing arbitrary OS command execution, typically on Rust or similar frameworks.
- Exploitation leads to post‑exploitation behaviour: shell spawning, staging, evasion, secrets discovery, loader deployment.

### 6.2 What is EtherRAT?
- A modern implant that uses Web3/blockchain context for C2 (RPC endpoints).
- Might be delivered via supply‑chain (IDE extension) or post‑RCE loader.
- Known to target Rust or other modern binaries; can leverage encoded payloads, AMSI bypass, and stealthy outbound communication.

### 6.3 Why combine the two in detection?
- Rust4Shell is a likely vector for initial access; EtherRAT is a logical implant for sustained control, especially in environments with blockchain or dev operations.
- Both share behavioural patterns that our hunts address: RCE, staging, obfuscation, secrets, loaders, RPC.

---

## 7. MITRE mapping by attack stage

| Stage | Key Behaviour | MITRE Tactic | MITRE Technique | Why it matters |
|---|---|---|---|---|
| Initial Access | Exploit public‑facing Rust/JS server | Initial Access | **T1190** | Direct remote code execution; first foothold. |
| Execution | Shell spawn from web process | Execution | **T1059** | Immediate operator control and staging. |
| Ingress Tool Transfer | curl, wget, iwr downloads | Command & Control / Execution | **T1105** | Loading additional tooling or loader. |
| Defense Evasion | Encoded commands, AMSI bypass | Defense Evasion | **T1562.001; T1027** | Hiding payloads and bypassing inspection. |
| Credential Access | Secrets recon, file discovery | Credential Access | **T1081; T1552** | Gathering secrets for lateral movement or exfil. |
| Execution | Unsigned loader, Rust or binaries | Execution / User Execution | **T1059; T1204** | Implant or loader runs in user context. |
| Command and Control | RPC to blockchain endpoints | C2 | **T1102** | Persistent beacon; stealthy remote access. |
| Persistence | Extension persistence, config changes | Persistence / Defense Evasion | **T1547; T1195** | Ensures implant remains or returns after reboot. |

---

## 8. L3 Pivot Guidance

### 8.1 Process tree review
```
DeviceProcessEvents
| where Timestamp between (datetime(<start>) .. datetime(<end>))
| where DeviceId == "<device>"
| sort by Timestamp asc
```

### 8.2 File drop identification
```
DeviceFileEvents
| where InitiatingProcessId == <PID>
```

### 8.3 Network C2 confirmation
```
DeviceNetworkEvents
| where RemoteUrl has_any ("solana","infura","alchemy","etherscan","quicknode")
```

### 8.4 Secrets theft confirmation
```
DeviceFileEvents
| where FileName has_any (".env","id_rsa","token","key")
```

---

## 9. Appendix A — High‑Value Signals

| Behaviour | Why It Matters |
|----------|----------------|
| Web → Shell | Direct RCE evidence |
| curl| iwr with pipe | Fileless loader |
| AMSI bypass + Base64 | Evasion / operator intent |
| Secrets recon | Credential theft |
| Unsigned loader in user path | Implant execution |
| IDE/Extension abuse | Supply‑chain compromise |
| Ghost module load | Malicious module or reflective load |
| RPC to Web3 providers | Implant beacon or C2 |

---

## 10. Appendix B — Suppression vs Escalation Rules

### Suppress only if
- Legitimate CI/CD or developer build processes proven, with documented allowlist.
- Dev host with clear business justification and no other risky signals.
- Named extension clearly approved and no unusual behaviour.

### Escalate always if
- Non‑dev host with IDE or extension abuse.
- P1 signals from Obfuscation, SecretsRecon, FileDrop, Persistence, or RPC correlation.
- Rapid pivot from WebRCE to RPC or extension abuse.
- Unverified or unsigned binaries executed from Temp or AppData.

---

## 11. Appendix C — Advanced KQL Pivot Kits

### Web Shell Session Replay
```
DeviceProcessEvents
| where Timestamp between (datetime(<start>) .. datetime(<end>))
| where DeviceId == "<device>"
| order by Timestamp asc
```

### Follow‑on persistence
```
DeviceRegistryEvents
| where ActionType == "RegistryValueSet"
| where RegistryKey has_any ("Run","RunOnce","Services")
```

### Lateral movement attempts
```
DeviceNetworkEvents
| where RemotePort in (22,3389,5985)
```

---

# END – Unified Rust4Shell + EtherRAT L3 Handbook
